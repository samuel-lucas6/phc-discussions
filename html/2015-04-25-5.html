<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style type="text/css">
body { font-size: 16px; }
.cal_brief { text-align: center; }
.cal_brief td:first-child { background: inherit; }
.cal_brief td { background: #ccc; width: 5ex; padding: 2px; }
.cal_big { text-align: center; padding: 0; margin: 0; }
.cal_big td { padding: 0 2px; }
.cal_mon { text-align: center; }
.cal_mon th { font-size: small; padding: 0; margin: 0; }
.cal_mon td { background: #ccc; width: 5ex; height: 1.5em;
	padding: 2px; text-align: right; }
.cal_mon td[colspan] { background: inherit; }
.cal_mon sup { color: #F0F0F0; text-align: left; float: left;
	margin-top: -2pt; font-weight: bold; }
.cal_mon a { text-align: right; margin-left: -4em; float: right; }
</style>

<title>phc-discussions - Re: [PHC] yescrypt AVX2</title>


</head>

<BODY bgcolor="#E0E0E0" text="black" link="blue" alink="red" vlink="navy">



<TABLE bgcolor="white" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD width="39%">
<A HREF="http://lists.openwall.net">lists.openwall.net</A>
<TD width="1%" rowspan="3">&nbsp;
<TD width="60%" align="right" rowspan="3">
<A HREF="/">lists</A>&nbsp;
/&nbsp;
<A HREF="http://www.openwall.com/lists/announce/">announce</A>&nbsp;
<A HREF="http://www.openwall.com/lists/owl-users/">owl-users</A>&nbsp;
<A HREF="http://www.openwall.com/lists/owl-dev/">owl-dev</A>&nbsp;
<A HREF="http://www.openwall.com/lists/john-users/">john-users</A>&nbsp;
<A HREF="http://www.openwall.com/lists/john-dev/">john-dev</A>&nbsp;
<A HREF="http://www.openwall.com/lists/passwdqc-users/">passwdqc-users</A>&nbsp;
<A HREF="http://www.openwall.com/lists/yescrypt/">yescrypt</A>&nbsp;
<A HREF="http://www.openwall.com/lists/popa3d-users/">popa3d-users</A>&nbsp;
/&nbsp;
<A HREF="http://www.openwall.com/lists/oss-security/">oss-security</A>&nbsp;
<A HREF="http://www.openwall.com/lists/kernel-hardening/">kernel-hardening</A>&nbsp;
<A HREF="http://www.openwall.com/lists/musl/">musl</A>&nbsp;
<A HREF="http://www.openwall.com/lists/sabotage/">sabotage</A>&nbsp;
<A HREF="http://www.openwall.com/lists/tlsify/">tlsify</A>&nbsp;
<A HREF="http://www.openwall.com/lists/passwords/">passwords</A>&nbsp;
/&nbsp;
<A HREF="http://www.openwall.com/lists/crypt-dev/">crypt-dev</A>&nbsp;
<A HREF="http://www.openwall.com/lists/xvendor/">xvendor</A>&nbsp;
/&nbsp;
<A HREF="/bugtraq/">Bugtraq</A>&nbsp;
<A HREF="/full-disclosure/">Full-Disclosure</A>&nbsp;
<A HREF="/linux-kernel/">linux-kernel</A>&nbsp;
linux-<A HREF="/netdev/">netdev</A>&nbsp;
<A HREF="/linux-ext4/">linux-ext4</A>&nbsp;
<a href="/linux-hardening/">linux-hardening</a>&nbsp;
<a href="/linux-cve-announce/">linux-cve-announce</a>&nbsp;
<a href="/phc-discussions/">PHC</a>&nbsp;
<TR><TD>
<DIV><FONT SIZE="-2"><I>Open Source and information security mailing list archives</I></FONT></DIV>
<TR><TD>&nbsp;
</TABLE>

<TABLE bgcolor="#B4D0DC" width="100%" border="0" cellspacing="0" cellpadding="1">
<TR><TD>
<TABLE width="100%" border="0" cellspacing="0" cellpadding="2">
<TR><TD bgcolor="#ECF8FF">

<a href="https://hashsuite.openwall.net/android">
Hash Suite for Android: free password hash cracker in your pocket</a>


</TABLE>
</TABLE>


<a href="4">[&lt;prev]</a> <a href="6">[next&gt;]</a> <a href="2">[&lt;thread-prev]</a> <a href="10">[thread-next&gt;]</a> <a href=".">[day]</a> <a href="..">[month]</a> <a href="../..">[year]</a> <a href="../../..">[list]</a>
<pre style="white-space: pre-wrap">
Message-ID: &lt;1288849836.51025574.1429975409046.JavaMail.root&#64;larc.usp.br&gt;
Date: Sat, 25 Apr 2015 12:23:29 -0300 (BRT)
From: Marcos Antonio Simplicio Junior &lt;mjunior&#64;...c.usp.br&gt;
To: discussions&#64;...sword-hashing.net
Subject: Re: [PHC] yescrypt AVX2

Hi, 

----- Mensagem original -----

&gt; De: "Solar Designer" &lt;solar&#64;...nwall.com&gt;
&gt; Para: discussions&#64;...sword-hashing.net
&gt; Enviadas: SÃ¡bado, 25 de Abril de 2015 5:09:59
&gt; Assunto: [PHC] yescrypt AVX2

&gt; Hi,

&gt; So I thought that AVX2 could be of significant help even when pwxform
&gt; is
&gt; tuned for 128-bit gather lanes, like we want it to be for better
&gt; bcrypt-like anti-GPU on the (currently widespread) machines that can
&gt; only do 128-bit SIMD and not wider yet.

&gt; It appears that I was mostly wrong, speaking of AVX2 as implemented
&gt; in
&gt; Haswell. My expectation for AVX2 working reasonably well even when
&gt; "misused" like that was based on my previous experiments (unreleased)
&gt; with 64-bit bcrypt-like S-box lookups in 128-bit SIMD code, on
&gt; SSE*/AVX
&gt; where we have _mm_loadl_epi64() and _mm_loadh_pi() to efficiently
&gt; load
&gt; 64-bit halves of a 128-bit register. On SSE4.1, there are also
&gt; instructions to extract 32- or 64-bit words from anywhere in a
&gt; 128-bit
&gt; register. I thought it'd be similar for 128-bit loads to 256-bit
&gt; registers. However, it turns out there's a 3 cycle latency to access
&gt; the upper 128-bit halves of 256-bit registers on Haswell, such as
&gt; with
&gt; _mm256_inserti128_si256() and _mm256_extracti128_si256() or
&gt; _mm256_permute4x64_epi64(), and the word-extract instructions do not
&gt; directly operate on the upper 128 bits. So it's 3 cycles to extract
&gt; would-be S-box indices from there, and it's another 3 cycles to load
&gt; the
&gt; S-box lookup result in there. Oops.

&gt; Now, there may be hacks around some of this, such as by doing a
&gt; 256-bit
&gt; load from 16 bytes below the desired offset (thereby loading the
&gt; lower
&gt; 128 bits with garbage and the upper 128 bits with what's needed) and
&gt; then loading the lower 128 bits with what's needed there. I've tried
&gt; this, and it works, but at least without a change to data layout to
&gt; make
&gt; those 256-bit loads always (rather than half of the time) 256-bit
&gt; aligned the performance is no better than with
&gt; _mm256_inserti128_si256(). Also, when implementing at intrinsics
&gt; level,
&gt; I resorted to using a combination of _mm256_loadu_si256() and
&gt; _mm256_blend_epi32(), since I guess _mm256_castsi128_si256() is not
&gt; meant to be used on the left-hand side. When implementing in
&gt; assembly,
&gt; I think it can be two loads (no need for a blend instruction), but I
&gt; doubt it'd be any faster (same instruction count, and blend is fast).
&gt; And I doubt the alignment would make all the difference, as I think
&gt; Haswell has fast unaligned loads from cache (we are occasionally
&gt; crossing a cache line, though).

&gt; Samuel - any thoughts on accessing the upper 128 bits faster?

&gt; So far, the best I achieved when going from AVX to AVX2 yet insisting
&gt; on
&gt; 128-bit S-box lookups is:

&gt; AVX:
&gt; enchmarking 1 thread ...
&gt; 930 c/s real, 930 c/s virtual (1023 hashes in 1.10 seconds)
&gt; Benchmarking 8 threads ...
&gt; 3410 c/s real, 433 c/s virtual (7161 hashes in 2.10 seconds)

&gt; AVX2:
&gt; Benchmarking 1 thread ...
&gt; 710 c/s real, 710 c/s virtual (1023 hashes in 1.44 seconds)
&gt; Benchmarking 8 threads ...
&gt; 3580 c/s real, 458 c/s virtual (7161 hashes in 2.00 seconds)

&gt; at 2 MB per hash on i7-4770K, with otherwise currently default
&gt; yescrypt
&gt; settings (PWXrounds=6, etc.) As you can see, single thread
&gt; performance
&gt; went down by 24%, and 8-thread went up only by 5%.

&gt; It's good news that attackers probably also can't use Haswell to
&gt; attack
&gt; yescrypt hashes tuned for older CPUs (with 128-bit S-box lookups)
&gt; much
&gt; faster. It's bad news that defenders can't benefit from Haswell
&gt; either.

&gt; It looks like I might introduce separate pwxform settings for AVX2,
&gt; using 256-bit S-box lookups. Maybe I'll try 512-bit as well, and see
&gt; if
&gt; it becomes much weaker than bcrypt on Haswell or not (maybe target L2
&gt; cache with the S-boxes, then). (256-bit would definitely be fine in
&gt; terms of bcrypt-like anti-GPU on Haswell.) If it's fine then 512-bit
&gt; would be preferable in order to avoid introducing yet another
&gt; combination of settings for MIC and AVX-512. Note: all of this fits
&gt; into yescrypt and pwxform as currently specified. We're only talking
&gt; of
&gt; adjusting the PWX* compile-time settings (and possibly making them
&gt; runtime tunable), deviating from the current defaults, and producing
&gt; optimized code for those (the -ref will run fine with only #define's
&gt; changed).

&gt; OTOH, we may be satisfied with the current defaults as being a good
&gt; fit
&gt; for up to x86/AVX and ARM/NEON, and appearing to defeat attacks with
&gt; newer CPUs so far. With these settings, Haswell performs almost like
&gt; Sandy/Ivy Bridge do - no worse, but also no better. Maybe that's
&gt; fine.

&gt; I've attached a patch containing my experiments, including several
&gt; AVX2
&gt; code versions of PWXFORM_SIMD. All of those use 128-bit S-boxes so
&gt; far.

&gt; Alexander

Just to share some experience we had on the AVX2 matter: last year, an undergrad (student of a colleague of mine, from a different university) implemented Lyra2 taking advantage of AVX2 and got a 30% speed up with his implementation. 

The results were reported in Portuguese (<a href="https://github.com/guilherme-pg/lyra2/blob/master/pfg/relatorio.pdf" rel="nofollow">https://github.com/guilherme-pg/lyra2/blob/master/pfg/relatorio.pdf</a>: see the "30%" figure at the end of page 8) and the specification is not the current one (although similar speed ups are likely to apply to the curretnt version, since most optimization applied to Blake), so I did not mention it earlier, but thinking back we should try to reproduce his results... One more task in our TODO list... :) 

Regards, 

Marcos. 

<span style="font-family: times;"><strong>Content of type "</strong>text/html<strong>" skipped</strong></span>
</pre>
<p><a href="https://www.openwall.com/blists/">Powered by blists</a> - <a href="https://lists.openwall.net">more mailing lists</a>


<p>




</body>
</html>
