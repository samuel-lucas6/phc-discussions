<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style type="text/css">
body { font-size: 16px; }
.cal_brief { text-align: center; }
.cal_brief td:first-child { background: inherit; }
.cal_brief td { background: #ccc; width: 5ex; padding: 2px; }
.cal_big { text-align: center; padding: 0; margin: 0; }
.cal_big td { padding: 0 2px; }
.cal_mon { text-align: center; }
.cal_mon th { font-size: small; padding: 0; margin: 0; }
.cal_mon td { background: #ccc; width: 5ex; height: 1.5em;
	padding: 2px; text-align: right; }
.cal_mon td[colspan] { background: inherit; }
.cal_mon sup { color: #F0F0F0; text-align: left; float: left;
	margin-top: -2pt; font-weight: bold; }
.cal_mon a { text-align: right; margin-left: -4em; float: right; }
</style>

<title>phc-discussions - Re: [PHC] Supporting AVX2/SSE2 or not with a single binary</title>


</head>

<BODY bgcolor="#E0E0E0" text="black" link="blue" alink="red" vlink="navy">



<TABLE bgcolor="white" width="100%" border="0" cellspacing="0" cellpadding="0">
<TR>
<TD width="39%">
<A HREF="http://lists.openwall.net">lists.openwall.net</A>
<TD width="1%" rowspan="3">&nbsp;
<TD width="60%" align="right" rowspan="3">
<A HREF="/">lists</A>&nbsp;
/&nbsp;
<A HREF="http://www.openwall.com/lists/announce/">announce</A>&nbsp;
<A HREF="http://www.openwall.com/lists/owl-users/">owl-users</A>&nbsp;
<A HREF="http://www.openwall.com/lists/owl-dev/">owl-dev</A>&nbsp;
<A HREF="http://www.openwall.com/lists/john-users/">john-users</A>&nbsp;
<A HREF="http://www.openwall.com/lists/john-dev/">john-dev</A>&nbsp;
<A HREF="http://www.openwall.com/lists/passwdqc-users/">passwdqc-users</A>&nbsp;
<A HREF="http://www.openwall.com/lists/yescrypt/">yescrypt</A>&nbsp;
<A HREF="http://www.openwall.com/lists/popa3d-users/">popa3d-users</A>&nbsp;
/&nbsp;
<A HREF="http://www.openwall.com/lists/oss-security/">oss-security</A>&nbsp;
<A HREF="http://www.openwall.com/lists/kernel-hardening/">kernel-hardening</A>&nbsp;
<A HREF="http://www.openwall.com/lists/musl/">musl</A>&nbsp;
<A HREF="http://www.openwall.com/lists/sabotage/">sabotage</A>&nbsp;
<A HREF="http://www.openwall.com/lists/tlsify/">tlsify</A>&nbsp;
<A HREF="http://www.openwall.com/lists/passwords/">passwords</A>&nbsp;
/&nbsp;
<A HREF="http://www.openwall.com/lists/crypt-dev/">crypt-dev</A>&nbsp;
<A HREF="http://www.openwall.com/lists/xvendor/">xvendor</A>&nbsp;
/&nbsp;
<A HREF="/bugtraq/">Bugtraq</A>&nbsp;
<A HREF="/full-disclosure/">Full-Disclosure</A>&nbsp;
<A HREF="/linux-kernel/">linux-kernel</A>&nbsp;
linux-<A HREF="/netdev/">netdev</A>&nbsp;
<A HREF="/linux-ext4/">linux-ext4</A>&nbsp;
<a href="/linux-hardening/">linux-hardening</a>&nbsp;
<a href="/linux-cve-announce/">linux-cve-announce</a>&nbsp;
<a href="/phc-discussions/">PHC</a>&nbsp;
<TR><TD>
<DIV><FONT SIZE="-2"><I>Open Source and information security mailing list archives</I></FONT></DIV>
<TR><TD>&nbsp;
</TABLE>

<TABLE bgcolor="#B4D0DC" width="100%" border="0" cellspacing="0" cellpadding="1">
<TR><TD>
<TABLE width="100%" border="0" cellspacing="0" cellpadding="2">
<TR><TD bgcolor="#ECF8FF">

<a href="https://hashsuite.openwall.net/android">
Hash Suite for Android: free password hash cracker in your pocket</a>


</TABLE>
</TABLE>


<a href="6">[&lt;prev]</a> <a href="8">[next&gt;]</a> <a href="6">[&lt;thread-prev]</a> <a href="8">[thread-next&gt;]</a> <a href=".">[day]</a> <a href="..">[month]</a> <a href="../..">[year]</a> <a href="../../..">[list]</a>
<pre style="white-space: pre-wrap">
Message-ID: &lt;CAOLP8p5-gBoHfWWCDwmBOTmLDJkkG9k+dKBb+51O12FuF1c=oA&#64;mail.gmail.com&gt;
Date: Wed, 19 Mar 2014 23:23:09 -0400
From: Bill Cox &lt;waywardgeek&#64;...il.com&gt;
To: discussions&#64;...sword-hashing.net
Subject: Re: [PHC] Supporting AVX2/SSE2 or not with a single binary

On Wed, Mar 19, 2014 at 10:39 PM, Steve Thomas &lt;steve&#64;...tu.com&gt; wrote:
&gt;&gt; On March 19, 2014 at 8:09 PM Andy Lutomirski &lt;luto&#64;...capital.net&gt; wrote:
&gt;&gt;
&gt;&gt; On Wed, Mar 19, 2014 at 5:54 PM, Bill Cox &lt;waywardgeek&#64;...il.com&gt; wrote:
&gt;&gt; &gt; One reason I think we see applications running without SSE/AVX2
&gt;&gt; &gt; support is that operating systems don't want to support two versions
&gt;&gt; &gt; of a binary, and they have to support older machines. The Blake2 code
&gt;&gt; &gt; I've read does not provide for a single binary that supports both - I
&gt;&gt; &gt; have to link either to the blake2-ref code or the blake2-sse code. My
&gt;&gt; &gt; TwoCats code has inherited this limitation, since I used the Blake2
&gt;&gt; &gt; code as a roadmap for figuring out how SSE2 works. These guys over on
&gt;&gt; &gt; StackOverflow think they've got code to detect SIMD support and allow
&gt;&gt; &gt; a single binary to support both:
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; <a href="http://stackoverflow.com/questions/6121792/how-to-check-if-a-cpu-supports-the-sse3-instruction-set" rel="nofollow">http://stackoverflow.com/questions/6121792/how-to-check-if-a-cpu-supports-the-sse3-instruction-set</a>
&gt;&gt;
&gt;&gt; That answer is crap. You cannot detect whether AVX is usable using
&gt;&gt; just cpuid -- you need to use (IIRC) xgetbv as well.
&gt;
&gt; Agree.
&gt;
&gt;&gt; On gcc 4.8 and up, function multiversioning [1] is probably the way to
&gt;&gt; go. On Windows (if you want to support MSVC), you'll need to do
&gt;&gt; something different. Of course, function multiversioning has the same
&gt;&gt; bug [2] and no one has fixed it yet.
&gt;&gt;
&gt;&gt; [1] <a href="http://gcc.gnu.org/wiki/FunctionMultiVersioning" rel="nofollow">http://gcc.gnu.org/wiki/FunctionMultiVersioning</a>
&gt;&gt; [2] <a href="http://gcc.gnu.org/bugzilla/show_bug.cgi?id=55307" rel="nofollow">http://gcc.gnu.org/bugzilla/show_bug.cgi?id=55307</a>
&gt;
&gt; Disagree. That's cool and all but worthless: only Linux and buggy.

This clearly is an area in flux.  I hope we get something decent soon.
 It's not just crypto that could be sped up.  This could be quite
valuable in my day job.  However, all our code gets compiled in an
ancient version of Red Hat Enterprise for supported releases.

&gt; Bill don't try to learn SS*E*/AVX* from the blake2-ref code... besides being
&gt; buggy. It is really hard to read. For me it was actually easier to read code
&gt; (<a href="https://github.com/dchest/blake2b" rel="nofollow">https://github.com/dchest/blake2b</a>) in a language I don't know than to read
&gt; that. I was trying to figure out how Blake2b worked and with the combination
&gt; of bad doc and bad code it was "impossible" (not worth a few hours). Until
&gt; finding a simple  implementation in Go.

I haven't read the reference version.  I suspect it was written by a
different author.  The Blake2s-sse version (and my TwoCats SSE version
that copies a lot from it) are difficult to read.  Maybe I'm just
getting old, but SIMD coding is a difficult.  If I saw a single
worthwhile improvement to be made in the Blake2-sse code, I would have
posted it here.  For groking what it's doing, I'd prefer Python or
similar.  I'm not surprised the Go version was a better description of
what it does.

For doing what you've been doing - finding weaknesses - the Go version
is probably a lot better.  Your finding weaknesses, at least for my
code, has been pretty awesome, so I take what you say very seriously,
not that my opinion counts much in company like this.

&gt; The way I' ve been dealing with write "once" compile twice (Linux/Windows)
&gt; run best code "everywhere" is: <a href="http://www.tobtu.com/files/rt-bench.zip" rel="nofollow">http://www.tobtu.com/files/rt-bench.zip</a>
&gt; Specifically:  src/common.cpp (getInstructionSets()),  src/hashfactory.h,
&gt; and
&gt; src\hash\*. Note there are better ways to do this. This was just one I did
&gt; awhile ago and I am still like well I could change that and it would be
&gt; better.
&gt;
&gt; Also this is for a different purpose  hash cracking with rainbow tables but
&gt; can be used with hash cracking in general and parallel  hashing. These
&gt; implementations are all single block and are severely  length limited.  Oh
&gt; right it has support for detecting AVX2 but no code is written for it.
&gt; Although
&gt; it would be super easy to add it (I just wanted to test it first but at the
&gt; time I
&gt; don't think I knew about Intel's emulator and obviously  AVX2 was not out
&gt; yet
&gt; [this was all written in late 2011 and early  2012]).  One way to make this
&gt; better is using templates and static inline class  functions to do the minor
&gt; differences in  architectures .

I haven't looked yet, but I suspect I'd like the code better without
the C++ templates. C++ and it's insane implementation of templates,
among other features, slowed down the entire industry for years, IMO.
If you read a lot of typical C++ code, I suspect you'd agree with me.
It's the worst code in FOSS land, on average.  There is very little in
the world of computer languages that has caused so many bugs and
incredibly stupid implementations of simple functions.

Bill
</pre>
<p><a href="https://www.openwall.com/blists/">Powered by blists</a> - <a href="https://lists.openwall.net">more mailing lists</a>


<p>




</body>
</html>
